<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!doctype html&gt;</span></p>
<p class="p1"><span class="s1">&lt;html&gt;</span></p>
<p class="p1"><span class="s1">&lt;head&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta charset="utf-8" /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;title&gt;LIFF Attribution&lt;/title&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script src="https://static.line-scdn.net/liff/edge/2/sdk.js"&gt;&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:16px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>#status{white-space:pre-wrap}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.ok{color:green}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.err{color:#b00020}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;/head&gt;</span></p>
<p class="p1"><span class="s1">&lt;body&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;h2&gt;LIFF Attribution&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div id="status"&gt;Starting...&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// ===== CONFIG</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const LIFF_ID = "2008170245-Bv4ryW6X";<span class="Apple-converted-space"> </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// Deep link to chat</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const OA_LINK = "https://line.me/R/ti/p/@eleveniclinic";<span class="Apple-converted-space"> </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// ==============================================</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const statusEl = document.getElementById('status');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function log(msg, cls){ statusEl.innerHTML += "\n" + msg; if(cls) statusEl.className = cls; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>(async function main(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('Initializing LIFF...');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>await liff.init({ liffId: LIFF_ID });</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('✅ LIFF init OK', 'ok');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!liff.isLoggedIn()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>log('Not logged in — redirecting to LINE login...');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>liff.login();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return; // after login the webview reloads</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('Logged in — getting profile...');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const profile = await liff.getProfile();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('✅ Profile: ' + profile.displayName + ' (' + profile.userId + ')', 'ok');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// read UTM params</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const params = new URLSearchParams(window.location.search);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const utm_source = params.get('utm_source') || '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const utm_campaign = params.get('utm_campaign') || '';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// payload to send to forwarder</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const payload = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>userId: profile.userId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>displayName: profile.displayName,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>utm_source,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>utm_campaign,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>timestamp: new Date().toISOString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('Sending attribution to server...');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const res = await fetch('/api/track', {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>method: 'POST',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>headers: {'Content-Type':'application/json'},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>credentials: 'same-origin',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>body: JSON.stringify(payload)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!res.ok) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const txt = await res.text();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>throw new Error('track failed: ' + res.status + ' ' + txt);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('✅ Sent to server. Redirecting to OA chat in 1s...', 'ok');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setTimeout(()=&gt;{ window.location.href = OA_LINK; }, 1000);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} catch (err) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>console.error(err);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>log('❌ Error: ' + (err.message || err), 'err');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>})();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</span></p>
<p class="p1"><span class="s1">&lt;/body&gt;</span></p>
<p class="p1"><span class="s1">&lt;/html&gt;</span></p>
</body>
</html>
