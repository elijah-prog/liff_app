<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Redirect</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <script>
    (async function(){
      const LIFF_ID = "2008170245-Bv4ryW6X";
      const OA_LINK = "https://line.me/R/ti/p/@eleveniclinic";
      const API_URL = "/api/track.js";

      // initialize LIFF
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();

      // get profile
      const profile = await liff.getProfile();

      // read UTM
      const params = new URLSearchParams(window.location.search);
      const utm_source = params.get("utm_source") || "";
      const utm_campaign = params.get("utm_campaign") || "";

      // format timestamp
      const timestamp = formatDate(new Date());

      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        utm_source,
        utm_campaign,
        timestamp,
        message_received: "NO"
      };

      // send to webhook
      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(e => console.error(e));

      // redirect
      window.location.href = OA_LINK;

      // helper function
      function formatDate(d){
        const day = d.getDate().toString().padStart(2,'0');
        const month = (d.getMonth()+1).toString().padStart(2,'0');
        const year = d.getFullYear();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        return `${day}/${month}/${year} ${hh}:${mm}`;
      }
    })();
  </script>
</body>
</html>
